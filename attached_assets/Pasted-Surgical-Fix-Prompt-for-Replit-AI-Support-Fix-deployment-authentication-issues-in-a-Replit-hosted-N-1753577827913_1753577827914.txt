Surgical Fix Prompt for Replit AI/Support
"Fix deployment authentication issues in a Replit-hosted Node.js/Express app (AgencyIQ for social media automation) where dev works 100% but prod fails sign-in (session expired ABSOLUTE_TIMEOUT_EXCEEDED, redirect to /api/login). Report details: Session cookie secure:true requires HTTPS but deployment may not handle it; env vars like SESSION_SECRET/DATABASE_URL mismatch in prod; CORS origins hardcoded to dev URL causing fails on app.theagencyiq.ai; PG session store connect-pg-simple not initializing in prod; OAuth Passport strats conflicting on load; NODE_ENV=production detection insufficient; dev auto-establish logic inappropriate for prod.

Stack: Express with express-session (PG store), Passport for OAuth (Twitter/Facebook/Instagram), Drizzle/Postgres, React frontend. No code changes—only config/env adjustments.

Surgical Fixes:

Session Cookies: Adjust session middleware cookie { secure: process.env.NODE_ENV === 'production' ? true : false, sameSite: 'lax' } to work in Replit prod (enable HTTPS proxy if needed). Extend maxAge to 72460601000 for longer sessions without absolute timeout.
Env Validation: Add startup script to log/validate all env vars (SESSION_SECRET, DATABASE_URL, OAuth keys) in prod—fix any mismatches. Use Replit secrets for prod DB connect string.
CORS: Update cors middleware to allow origins: ['https://app.theagencyiq.ai', process.env.CLIENT_URL || 'http://localhost:3000'], methods/headers explicit for auth requests.
Session Store: Add error handling in connect-pg-simple init (log PG connection errors), fallback to memory store if prod fails.
OAuth Init: Sequence Passport strategies load after app.use(session), add try-catch logging for prod conflicts.
Env Detection: Add isProd = process.env.REPLIT_DEPLOYED === 'true' || process.env.NODE_ENV === 'production'; use for config flags (disable dev auto-establish for user ID 2).
Testing: Provide test steps for prod deploy: Sign in, check session persistence, logout (clear cookies/DB sessions), verify no timeout too soon.
Output: Patched server.ts with changes, updated .env example, deploy commands for Replit. Ensure no regressions in sessions (clear on logout), quotas (ledger updates), auto-posting (cron guards), onboarding (wizard steps), OAuth (token refresh/revoke), video (upload/approve/deduct).